#################################################
# NOTES: This script is run as an array script. It requires a support file "namelist" which contains a list of specimen names.
#################################################


#!/bin/bash -l
#SBATCH --job-name=MapDamage
#SBATCH --output=array_job_out_%A_%a.txt
#SBATCH --error=array_job_err_%A_%a.txt
#SBATCH --account=project_2006079
#SBATCH --partition=small
#SBATCH --time=72:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=2
#SBATCH --mem-per-cpu=24G
#SBATCH --array=1-54

#set the input file to process
name=$(sed -n ${SLURM_ARRAY_TASK_ID}p namelist)

module load mapdamage2/2.2.2
module load biopythontools
module load r-env/421
module load biokit

#get the data
mapDamage -i /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_mitoG/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.bam -r /scratch/project_2006079/genomes/CacGal_mitogenome/CacGal_mitogenome.fasta -d /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name} --rescale

samtools sort -m 24G -@ 2 -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.rescaled.bam

samtools index /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam

samtools flagstat /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam > /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam.flagstat

samtools depth /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam | awk '{sum+=$3; sumsq+=$3*$3} END { print "Average = ",sum/NR; print "Stdev = ",sqrt(sumsq/NR - (sum/NR)**2)}' > /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name}/coverage_${name}.txt


chmod -R 777 *

rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_mitoG/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.rescaled.bam
