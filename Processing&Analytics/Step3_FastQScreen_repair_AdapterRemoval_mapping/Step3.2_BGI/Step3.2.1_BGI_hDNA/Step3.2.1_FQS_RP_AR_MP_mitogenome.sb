#################################################
# NOTES: This script is run as an array job. It requires a support file of specimen names called "namelist".
#################################################


#!/bin/bash -l
#SBATCH --job-name=FstqSc
#SBATCH --output=array_job_out_%A_%a.txt
#SBATCH --error=array_job_err_%A_%a.txt
#SBATCH --account=project_2006079
#SBATCH --partition=small
#SBATCH --time=72:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --mem-per-cpu=12G
#SBATCH --array=1-21

#set the input file to process
name=$(sed -n ${SLURM_ARRAY_TASK_ID}p namelist)

module load bwa
module load biokit

#filter out mtDNA cockatoo reads
/projappl/project_2006079/miniconda3/envs/fastq_screen/bin/fastq_screen --tag --filter 100000 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/BGI_data/F22FTSHMHT1560_ANIpqfzR/soapnuke/mergedfastq/${name}_1.fastq.gz /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/BGI_data/F22FTSHMHT1560_ANIpqfzR/soapnuke/mergedfastq/${name}_2.fastq.gz -outdir /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG

#fix the mate pair issue with bbtools repair.sh
module load bbtools/38.96
repair.sh in1=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_1.tagged_filter.fastq.gz in2=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_2.tagged_filter.fastq.gz out1=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_1.tagged_filter_fixed1.fastq out2=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_2.tagged_filter_fixed2.fastq

#unzip
gunzip -d /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_1.tagged_filter_fixed1.fastq.gz
gunzip -d /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_2.tagged_filter_fixed2.fastq.gz

#repair sequence names
sed -i 's/#FQST:CockatooMTDNA:Human:Bacteria:Mollusks:Covid:Hornbill:100000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_1.tagged_filter_fixed1.fastq

sed -i 's/#FQST:100000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_1.tagged_filter_fixed1.fastq

sed -i 's/#FQST:CockatooMTDNA:Human:Bacteria:Mollusks:Covid:Hornbill:100000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_2.tagged_filter_fixed2.fastq

sed -i 's/#FQST:100000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_2.tagged_filter_fixed2.fastq

#zip outputs
gzip /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_1.tagged_filter_fixed1.fastq
gzip /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_2.tagged_filter_fixed2.fastq

#Adapter removal
/projappl/project_2006079/adapterremoval/bin/AdapterRemoval --file1 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_1.tagged_filter_fixed1.fastq.gz --file2 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_mitoG/${name}_2.tagged_filter_fixed2.fastq.gz --adapter1 AGTCGGAGGCCAAGCGGTCTTAGGAAGACAANNNNNNNNNNCAACTCCTTGGCTCACA --adapter2 TTGTCTTCCTAAGGAACGACATGGCTACGATCCGACTT --basename /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_mitoG/${name} --collapse --trimns --trimqualities --gzip

#Alignment
bwa mem -t4 -M /scratch/project_2006079/genomes/CacGal_mitogenome/CacGal_mitogenome.fasta /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_mitoG/${name}.pair1.truncated.gz /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_mitoG/${name}.pair2.truncated.gz | samtools view -F4 -hb -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step4_preliminary_bams_mitoG/${name}_PE.bam
bwa mem -t4 -M /scratch/project_2006079/genomes/CacGal_mitogenome/CacGal_mitogenome.fasta /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_mitoG/${name}.collapsed.gz | samtools view -F4 -hb -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step4_preliminary_bams_mitoG/${name}_ME.bam
bwa mem -t4 -M /scratch/project_2006079/genomes/CacGal_mitogenome/CacGal_mitogenome.fasta /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_mitoG/${name}.collapsed.truncated.gz | samtools view -F4 -hb -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step4_preliminary_bams_mitoG/${name}_MET.bam
